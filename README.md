# px-microservices

Container based on [Google's microservices demo](https://github.com/GoogleCloudPlatform/microservices-demo)

## Instructions

### Create a k8s cluster on GKS
```
gcloud container clusters create pixie-demo --min-nodes=1 --max-nodes=1 --num-nodes=2 --zone=us-central1-a -m n1-standard-4
```

### Update kubectl config
```
gcloud container clusters get-credentials pixie-demo --zone=us-central1-a
```

### Deploy pixie!
```
px deploy
```

### Run demo
```
$ kubectl apply -f kubernetes-manifests.yaml
```

### Get front end adress
```
$ kubectl get service frontend-external
```

### Run pixie scripts!
```
$ px run px/service_stats
$ px run px/node_stats
$ px run px/service_memory
```
Alternatively you can see the metrics on [here](https://work.withpixie.ai/live)

### Deploy px-usewithcare!
```
$ kubectl apply -f px-usewithcare.yml
```

Then the external adress of the endpoint to run memEater and cpuBurner with:
```
$ kubectl get service usewithcare-external  --watch

NAME                    TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)        AGE
usewithcare-external   LoadBalancer   10.3.245.111   34.68.211.163   80:31146/TCP   16m
```

Load balancers take a while to provision so it might take a couple of minutes.

#### Run cpuBurner!

Get cpuBurner status:
```
$ curl http://<your adress>/cpuburner
```

For example:
```
$ curl http://34.68.211.163/cpuburner
{'cpuBurner': 'stopped'}%
```

Start cpuBurner:
```
$ curl http://34.68.211.163/cpuburner/start
{'cpuBurner': 'started'}%
```

Stop cpuBurner:
```
$ curl http://34.68.211.163/cpuburner/stop
{'cpuBurner': 'stopped'}%
```

Get pixie CPU metrics at:
```
px run px/node_stats
```

#### Run memEater!

With the same external address of the last load balancer:

Get memEater status:
```
$ curl http://34.68.211.163/memeater
{'memEater': 'stopped'}
```

Start memEater:
``` 
$ curl http://34.68.211.163/memeater/start/<memory in MB>
```

For example:
```
$ curl http://34.68.211.163/memeater/start/300
{'memEater': 'started'}
```
Free the memory:
```
$ curl http://34.68.211.163/memeater/free
{'memEater': 'stopped'}
```
If you need to increase or decrease the quantity of memory eaten by memEater you first need to stop the process and make another request to start it again, like so:

```
$ curl http://34.68.211.163/memeater/start/300
{'memEater': 'started'}

$ curl http://34.68.211.163/memeater/free
{'memEater': 'stopped'}

$ curl http://34.68.211.163/memeater/start/600
{'memEater': 'started'}
```
Get memory stats with pixie:
```
px run px/service_memory_usage
```

### Deploy px-locust!

```
$ kubectl apply -f px-locust.yml
```

Get px-locust endpoint adress:
```
$ kubectl get service locust-external --watch

NAME              TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)        AGE
locust-external   LoadBalancer   10.3.240.13   35.202.204.212   80:30561/TCP   18m
```

Load balancers take a while to provision so it might take a couple of minutes.

Get locust status:

```
$ curl http://<your locust service external address>/invokust/get
```

For example:
```
$ curl http://35.202.204.212/invokust/get
{"locust": "stopped"}%
```

Start locust:
```
curl -X POST -d "{\"users\": \"2\", \"hrate\": \"1\"}"  -H 'Content-Type: application/json' http://35.202.204.212/invokust
```
The users key is the number of users created by locust; the hrate key is the hatch rate on which locust creates the number users on the users key, for example, if the users key had a value of 100 and hrate a value of 10, locust would create 10 users every 1 to 3 seconds until it reached 100 users.

Stop locust:
```
curl http://35.202.204.212/invokust/stop
{"locust": "stopped"}%
```
If you need to change the number of users or the hrate you need to stop and restart the service, like so:
```
$ curl -X POST -d "{\"users\": \"2\", \"hrate\": \"1\"}"  -H 'Content-Type: application/json' http://35.202.204.212/invokust
{"locust": "running"}%

$ curl http://35.202.204.212/invokust/get
{"locust": "stopped"}%

$ curl -X POST -d "{\"users\": \"10\", \"hrate\": \"5\"}"  -H 'Content-Type: application/json' http://35.202.204.212/invokust
{"locust": "running"}%
```

See pixie metrics with:
```
px run px/service_stats
```

Traffic is generated by locust service insted of loadgen. The code for the Locust container can be found [here](https://github.com/JavierClairvaux/px-locust).

The code for the px-usewithcare container can be found [here](ihttps://github.com/JavierClairvaux/px-usewithcare).
